<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="C/C++," />





  <link rel="alternate" href="/atom.xml" title="rutk1t0r's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/blog.ico?v=5.0.2" />






<meta name="description" content="关于C/C++中结构体(类)内存对齐问题

各种笔试面试都会涉及的问题，具体的可以查阅相关标准(如C99,C11等)或者翻阅国外知名论坛stackoverflow等寻找相关资料进一步分析，我个人的一些总结如下，如有不对之处，还请诸位不吝赐教．


可参考资料：维基百科StackOverflow GCC StructureGCC文档
1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:3">
<meta property="og:type" content="article">
<meta property="og:title" content="memory_align">
<meta property="og:url" content="http://embpgp.github.io/2016/08/21/memory-align/index.html">
<meta property="og:site_name" content="rutk1t0r's blog">
<meta property="og:description" content="关于C/C++中结构体(类)内存对齐问题

各种笔试面试都会涉及的问题，具体的可以查阅相关标准(如C99,C11等)或者翻阅国外知名论坛stackoverflow等寻找相关资料进一步分析，我个人的一些总结如下，如有不对之处，还请诸位不吝赐教．


可参考资料：维基百科StackOverflow GCC StructureGCC文档
1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:3">
<meta property="og:image" content="http://embpgp.github.io/images/1.png">
<meta property="og:image" content="http://embpgp.github.io/images/2.png">
<meta property="og:image" content="http://embpgp.github.io/images/3.png">
<meta property="og:image" content="http://embpgp.github.io/images/4.png">
<meta property="og:image" content="http://embpgp.github.io/images/5.png">
<meta property="og:image" content="http://embpgp.github.io/images/6.png">
<meta property="og:image" content="http://embpgp.github.io/images/7.png">
<meta property="og:image" content="http://embpgp.github.io/images/8.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-1.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-2.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-3.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-4.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-5.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-6.png">
<meta property="og:image" content="http://embpgp.github.io/images/gcc-st-7.png">
<meta property="og:updated_time" content="2016-09-12T10:36:41.897Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="memory_align">
<meta name="twitter:description" content="关于C/C++中结构体(类)内存对齐问题

各种笔试面试都会涉及的问题，具体的可以查阅相关标准(如C99,C11等)或者翻阅国外知名论坛stackoverflow等寻找相关资料进一步分析，我个人的一些总结如下，如有不对之处，还请诸位不吝赐教．


可参考资料：维基百科StackOverflow GCC StructureGCC文档
1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:3">
<meta name="twitter:image" content="http://embpgp.github.io/images/1.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://embpgp.github.io/2016/08/21/memory-align/"/>


  <title> memory_align | rutk1t0r's blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?31cbb53616f160459c7d835bac187364";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">rutk1t0r's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">PGP 程序猿 攻城狮</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
            日程
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                memory_align
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-21T21:24:53+08:00" content="2016-08-21">
              2016-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/study/" itemprop="url" rel="index">
                    <span itemprop="name">study</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/21/memory-align/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/21/memory-align/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="关于C-C-中结构体-类-内存对齐问题"><a href="#关于C-C-中结构体-类-内存对齐问题" class="headerlink" title="关于C/C++中结构体(类)内存对齐问题"></a>关于C/C++中结构体(类)内存对齐问题</h2><hr>
<blockquote>
<p>各种笔试面试都会涉及的问题，具体的可以查阅相关标准(如C99,C11等)或者翻阅国外知名论坛<a href="http://stackoverflow.com/" title="Stack Overflow" target="_blank" rel="external">stackoverflow</a>等寻找相关资料进一步分析，我个人的一些总结如下，如有不对之处，还请诸位不吝赐教．</p>
</blockquote>
<hr>
<p>可参考资料：<br><a href="https://en.wikipedia.org/wiki/Data_structure_alignment#Problems" title="维基百科" target="_blank" rel="external">维基百科</a><br><a href="http://stackoverflow.com/questions/2554229/memory-alignment-within-gcc-structs" target="_blank" rel="external">StackOverflow GCC Structure</a><br><a href="https://gcc.gnu.org/onlinedocs/gcc/Type-Attributes.html" target="_blank" rel="external">GCC文档</a></p>
<h3 id="1-首先放出现代PC编译器在实现的时候对于字长的一些典型约定"><a href="#1-首先放出现代PC编译器在实现的时候对于字长的一些典型约定" class="headerlink" title="1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:"></a>1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:</h3><h4 id="32位编译器："><a href="#32位编译器：" class="headerlink" title="32位编译器："></a>32位编译器：</h4><pre><code>char ：1个字节
char*（即指针变量）: 4个字节（32位的寻址空间是2^32, 即32个bit，也就是4个字节。同理64位编译器）
short int : 2个字节
int：  4个字节
unsigned int : 4个字节
float:  4个字节
double:   8个字节
long:   4个字节
long long:  8个字节
unsigned long:  4个字节
</code></pre><h4 id="64位编译器："><a href="#64位编译器：" class="headerlink" title="64位编译器："></a>64位编译器：</h4><pre><code>char ：1个字节
char* (即指针变量): 8个字节
short int : 2个字节
int：  4个字节
unsigned int : 4个字节
float:  4个字节
double:   8个字节
long:   8个字节
long long:  8个字节
unsigned long:  8个字节  
</code></pre><p>其中特别需要说明的一点就是指针类型的，任何类型的指针字长(当然包括结构体和类等复合类型)几乎应该只与编译器平台或者说是处理器地址总线长度有关(当然类似8086这种16位的处理器20根地址线的CPU等就另当别论了).关于这一点我认为学过体系结构和组成原理的同学应该会有深刻体会(我们组成原理课有实验就是按照教程实现一个简单的CPU)．在C语言中直接使用操作符sizeof(type)就可以得到字节大小，注意这个sizeof不是一个函数而是一个操作符．操作符的话表明结果已经在编译的时候确定了，而函数的话如果编译器不进行优化则等到运行时被调用才会返回值．关于这一点sizeof在有数组的参数中会发生一些奇妙的事情．</p>
<hr>
<h3 id="2-变量排放规则-自己的见解"><a href="#2-变量排放规则-自己的见解" class="headerlink" title="2. 变量排放规则(自己的见解)"></a>2. 变量排放规则(自己的见解)</h3><h4 id="1-内置类型对象-如char、int-lt-现代PC编译器普遍为4字节-gt-等-的对齐起始地址为其本身大小和编译器默认大小（或用-pragma-pack（n-指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1-2-4-8等2的幂值）中最小的一个的整数倍"><a href="#1-内置类型对象-如char、int-lt-现代PC编译器普遍为4字节-gt-等-的对齐起始地址为其本身大小和编译器默认大小（或用-pragma-pack（n-指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1-2-4-8等2的幂值）中最小的一个的整数倍" class="headerlink" title="1. 内置类型对象(如char、int&lt;现代PC编译器普遍为4字节&gt;等)的对齐起始地址为其本身大小和编译器默认大小（或用#pragma pack（n)指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1,2,4,8等2的幂值）中最小的一个的整数倍."></a>1. 内置类型对象(如char<1字节>、int&lt;现代PC编译器普遍为4字节&gt;等)的<strong>对齐起始地址</strong>为其本身大小和编译器默认大小（或用#pragma pack（n)指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1,2,4,8等2的幂值）中最小的一个的整数倍.</1字节></h4><h4 id="2-整个结构体或者类的大小为它们中的内置类型大小最大的那一个和编译器默认大小（或用-pragma-pack-n-指定的n中两者较小的那个的整数倍-而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。"><a href="#2-整个结构体或者类的大小为它们中的内置类型大小最大的那一个和编译器默认大小（或用-pragma-pack-n-指定的n中两者较小的那个的整数倍-而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。" class="headerlink" title="2. 整个结构体或者类的大小为它们中的内置类型大小最大的那一个和编译器默认大小（或用#pragma pack (n)指定的n中两者较小的那个的整数倍,而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。"></a>2. 整个结构体或者类的<strong>大小</strong>为它们中的内置类型大小最大的那一个和编译器默认大小（或用#pragma pack (n)指定的n中两者较小的那个的整数倍,而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。</h4><blockquote>
<p>可能听起来很拗口，但是一旦把握了准则在应对这些问题的时候就很轻而易举了．其实主要是两个点，一个是变量放的偏移地址，另一个是复杂类型的总的大小．首先我们要知道为什么编译器需要对变量进行内存对齐？知道内存组织的童鞋可能有些感触，我们的代码运行的时候必须首先从磁盘(或其他非易失性介质)通过外部总线加载到内存中，然后再跳转到相应处运行．基于现有的计算机运行机制不断地进行<strong>取指，译码，执行等</strong>操作，由于内存本身的半导体的物理特性使得内存并不是一次性有几个G那么多而是通过很小的介质(一般是8位)不断地”串并联”起来的，一般能够保证一个地址能够寻址一个字节的数据，其实是半导体的导通与截止表示的计算机中的”1”和”0”．打个比方，如果地址不是偶数的，要取偶数个的数据的话，CPU在硬件上可能要多花几个时钟周期来进行取数据和整合，才能保证数据不出错．因此很多算法也都是以空间换时间的思想来加快计算．还有就是在嵌入式领域，由于板子或者芯片本身的内存资源非常有限，必须要求嵌入式程序员写出几乎<code>磕碜</code>的代码才能保证运行流畅等．因此，至少在不怎么缺内存的PC或者Server领域，为了加快计算，还是可以采用编译器进行的优化的．(可能还有其他技术比如缓存啥的我们先不讨论)</p>
</blockquote>
<h3 id="3-Win栗子如下："><a href="#3-Win栗子如下：" class="headerlink" title="3. Win栗子如下："></a>3. Win栗子如下：</h3><h4 id="1-这是以前我用Win的时候VC-6-0编译器的效果图"><a href="#1-这是以前我用Win的时候VC-6-0编译器的效果图" class="headerlink" title="1. 这是以前我用Win的时候VC++ 6.0编译器的效果图"></a>1. 这是以前我用Win的时候VC++ 6.0编译器的效果图</h4><p><img src="/images/1.png" alt="配置"></p>
<h4 id="2-此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的"><a href="#2-此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的" class="headerlink" title="2. 此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的"></a>2. 此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的</h4><p><img src="/images/2.png" alt="int b"></p>
<h4 id="3-下面这一处说明大小是按照int类型-最大呀-的整数倍来取"><a href="#3-下面这一处说明大小是按照int类型-最大呀-的整数倍来取" class="headerlink" title="3. 下面这一处说明大小是按照int类型(最大呀)的整数倍来取"></a>3. 下面这一处说明大小是按照int类型(最大呀)的整数倍来取</h4><p><img src="/images/3.png" alt="整数倍"></p>
<h4 id="4-说明当类型为数组的时候，只按照它的类型来对齐而非整个大小"><a href="#4-说明当类型为数组的时候，只按照它的类型来对齐而非整个大小" class="headerlink" title="4. 说明当类型为数组的时候，只按照它的类型来对齐而非整个大小"></a>4. 说明当类型为数组的时候，只按照它的类型来对齐而非整个大小</h4><p><img src="/images/4.png" alt="数组"></p>
<h4 id="5-说明第二个元素char类型的可以在任何偏移处安放-因为它是一个字节啊"><a href="#5-说明第二个元素char类型的可以在任何偏移处安放-因为它是一个字节啊" class="headerlink" title="5. 说明第二个元素char类型的可以在任何偏移处安放(因为它是一个字节啊)"></a>5. 说明第二个元素char类型的可以在任何偏移处安放(因为它是一个字节啊)</h4><p><img src="/images/5.png" alt="char"></p>
<h4 id="6-说明-pragma-pack-n-n非2的幂的值时候无效"><a href="#6-说明-pragma-pack-n-n非2的幂的值时候无效" class="headerlink" title="6. 说明#pragma pack (n) n非2的幂的值时候无效"></a>6. 说明#pragma pack (n) n非2的幂的值时候无效</h4><p><img src="/images/6.png" alt="#pragma pack (n)"></p>
<h4 id="7-说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数"><a href="#7-说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数" class="headerlink" title="7. 说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数"></a>7. 说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数</h4><p><img src="/images/7.png" alt="struct"></p>
<h4 id="8-说明pragma-pack-3-没作用"><a href="#8-说明pragma-pack-3-没作用" class="headerlink" title="8. 说明pragma pack (3)没作用"></a>8. 说明pragma pack (3)没作用</h4><p><img src="/images/8.png" alt="pack (3)"></p>
<h3 id="4-Linux栗子如下-据说gcc默认是4-bytes的对齐大小-："><a href="#4-Linux栗子如下-据说gcc默认是4-bytes的对齐大小-：" class="headerlink" title="4. Linux栗子如下(据说gcc默认是4 bytes的对齐大小)："></a>4. Linux栗子如下(据说gcc默认是4 bytes的对齐大小)：</h3><h4 id="1-这是我用ubuntu-16-04-amd64-ssh连接ubuntu-16-04-i386之后gcc版本号"><a href="#1-这是我用ubuntu-16-04-amd64-ssh连接ubuntu-16-04-i386之后gcc版本号" class="headerlink" title="1. 这是我用ubuntu 16.04 amd64 ssh连接ubuntu 16.04 i386之后gcc版本号:"></a>1. 这是我用ubuntu 16.04 amd64 ssh连接ubuntu 16.04 i386之后gcc版本号:</h4><p><img src="/images/gcc-st-1.png" alt="gcc -v"></p>
<h4 id="2-这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节"><a href="#2-这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节" class="headerlink" title="2. 这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节"></a>2. 这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节</h4><p><img src="/images/gcc-st-2.png" alt="4 butys"></p>
<h4 id="3-在gcc中加入功能和pragma-pack差不多的attribute选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…"><a href="#3-在gcc中加入功能和pragma-pack差不多的attribute选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…" class="headerlink" title="3. 在gcc中加入功能和pragma pack差不多的attribute选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…"></a>3. 在gcc中加入功能和pragma pack差不多的<strong>attribute</strong>选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…</h4><p><img src="/images/gcc-st-3.png" alt="attri_1"></p>
<h4 id="4-在这里只是a之后的那一个字节是填充的-short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，attribute干得好事"><a href="#4-在这里只是a之后的那一个字节是填充的-short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，attribute干得好事" class="headerlink" title="4. 在这里只是a之后的那一个字节是填充的,short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，attribute干得好事~"></a>4. 在这里只是a之后的那一个字节是填充的,short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，<strong>attribute</strong>干得好事~</h4><p><img src="/images/gcc-st-4.png" alt="attri_2"></p>
<h4 id="5-证明了有pack为1的地方必定不留一点空隙"><a href="#5-证明了有pack为1的地方必定不留一点空隙" class="headerlink" title="5. 证明了有pack为1的地方必定不留一点空隙~~~"></a>5. 证明了有pack为1的地方必定不留一点空隙~~~</h4><p><img src="/images/gcc-st-5.png" alt="pack_1"></p>
<h4 id="6-第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢-应该是它自己作为结构体的时候元素中最大的-这个栗子为double-要是有char-类型数组超过8，不用管，认为是char-和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．"><a href="#6-第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢-应该是它自己作为结构体的时候元素中最大的-这个栗子为double-要是有char-类型数组超过8，不用管，认为是char-和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．" class="headerlink" title="6. 第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢?应该是它自己作为结构体的时候元素中最大的(这个栗子为double,要是有char 类型数组超过8，不用管，认为是char)和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．"></a>6. 第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢?应该是它自己作为结构体的时候元素中最大的(这个栗子为double,要是有char 类型数组超过8，不用管，认为是char)和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．</h4><p><img src="/images/gcc-st-6.png" alt="st_to_st"></p>
<h4 id="7-由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．"><a href="#7-由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．" class="headerlink" title="7. 由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．"></a>7. 由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．</h4><p><img src="/images/gcc-st-7.png" alt="st_to_aligned(1)"></p>
<h3 id="5-C-中的高级之处"><a href="#5-C-中的高级之处" class="headerlink" title="5. C++中的高级之处"></a>5. C++中的高级之处</h3><blockquote>
<p>至于C和C++的区别我就不再重复教科书上的内容．只是觉得作为一个developer可能只会关心功能实现，不会管各种机制的内部实现，反正丢给编译器去翻译和安排就是咯，咱又不是研究者．但是一旦出现bug且需要调试器支持的时候，底层的实现就不得不去啃了．编译器也是人开发出来的，当然也少不了出问题，只是现代开发体系为了降低开发难度因此对计算机的<strong>封装</strong>程度已经快到了<code>说话编程</code>的地步了．重复造轮子有必要吗？珍爱生命，快用py？  </p>
</blockquote>
<h4 id="1-C-中的结构体和类的区别？"><a href="#1-C-中的结构体和类的区别？" class="headerlink" title="1.C++中的结构体和类的区别？"></a>1.C++中的结构体和类的区别？</h4><p>根据C++的标准它俩的区别应该只是默认的访问权限的不同，其他该有的编译器(比如构造函数，析构函数等)还是会允许程序员实现的．以前在微博上分析过一道题<a href="http://weibo.com/p/230418e682a92a0102w5wl?mod=zwenzhang" target="_blank" rel="external">链接</a>.因此，在C++中，为了让编译器能够根据标准对各种权限进行检查并生成程序员想要的代码，还是用class比较好．我们不能单调地看待private声明或者const的成员，认为它是不可能被子类或者其他非正常手段修改的．要知道我们所谓的编程最主要是根据标准和规则对编译器进行交互，让编译器取帮我们做翻译工作，一旦编译器通过，程序被加载到内存中后一切的一切被视为<code>高低电平</code>或者其他二进制信息，到时候让CPU译码之后想怎么干就怎么干~_~(当然这是intel 8086时代，从286开始就开始了保护模式).</p>
<h4 id="2-C-中class的虚函数"><a href="#2-C-中class的虚函数" class="headerlink" title="2. C++中class的虚函数"></a>2. C++中class的虚函数</h4><p>C++中的虚函数机制保证了动态绑定，实现了直到程序执行的时候才选择执行哪个代码．一般编译器的实现是在对象空间(类被实例化后)开始的4字节(32位OS)保存一个虚函数表指针，继承了几个类中的虚函数，一般就会产生几个虚函数表指针，再加上数据成员(除去静态成员),这个对象的大小大概就是这么多了．类的方法并不单独属于对象，每一次调用方法的时候必须要传入this指针，其实就是这个对象的首地址．在VC++中一般采用intel 的ecx寄存器作为this指针的载体．例如(<code>obj.func(a, b, c);</code>)在编译器翻译的汇编代码里面等价于(<code>func(&amp;obj, a, b, c);</code>),某些编译器甚至允许这样调用．因为底层的汇编代码一样啊….</p>
<hr>
<p>先总结这么多吧，其实想真正弄清楚的话还需亲自实现或者读懂一个编译器，不仅仅考虑编译原理里面的词语法分析等，而更要从硬件层面取理解各种软件设计思维模式．毕竟软件是跑在硬件这个载体上面的，各种效率问题要经得起推敲的，为啥选择了GNU/Linux呢？可不仅仅因为是开源免费的原因吧~_~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持特色口味技术分享，您的支持将鼓励我继续创作哦！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/zhifubao.png" alt="rutk1t0r Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/C-C/" rel="tag">#C/C++</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/08/16/hello-world/" rel="next" title="Hello world">
                <i class="fa fa-chevron-left"></i> Hello world
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/08/23/vim-and-emacs/" rel="prev" title="vim_and_emacs">
                vim_and_emacs <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/08/21/memory-align/"
     data-title="memory_align"
     data-content=""
     data-url="http://embpgp.github.io/2016/08/21/memory-align/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/08/21/memory-align/"
           data-title="memory_align" data-url="http://embpgp.github.io/2016/08/21/memory-align/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="rutk1t0r" />
          <p class="site-author-name" itemprop="name">rutk1t0r</p>
          <p class="site-description motion-element" itemprop="description">gnireenigne | 0x41414141 | \xff\xe4\xcc</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">11</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/embpgp" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/pgp_csust" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/wade.james.7" target="_blank" title="Facebook">
                  
                    <i class="fa fa-fw fa-facebook"></i>
                  
                  Facebook
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/3867322666" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.hicoder.cn" title="源神官网" target="_blank">源神官网</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.nephen.com" title="老吴官网" target="_blank">老吴官网</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hayifeng.github.io" title="小wulian" target="_blank">小wulian</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://hackercs.cn" title="唐大兄弟" target="_blank">唐大兄弟</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.fengpla.cn" title="锋四爷" target="_blank">锋四爷</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.cnblogs.com/fangyz" title="方小白" target="_blank">方小白</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#关于C-C-中结构体-类-内存对齐问题"><span class="nav-number">1.</span> <span class="nav-text">关于C/C++中结构体(类)内存对齐问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-首先放出现代PC编译器在实现的时候对于字长的一些典型约定"><span class="nav-number">1.1.</span> <span class="nav-text">1. 首先放出现代PC编译器在实现的时候对于字长的一些典型约定:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#32位编译器："><span class="nav-number">1.1.1.</span> <span class="nav-text">32位编译器：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#64位编译器："><span class="nav-number">1.1.2.</span> <span class="nav-text">64位编译器：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-变量排放规则-自己的见解"><span class="nav-number">1.2.</span> <span class="nav-text">2. 变量排放规则(自己的见解)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-内置类型对象-如char、int-lt-现代PC编译器普遍为4字节-gt-等-的对齐起始地址为其本身大小和编译器默认大小（或用-pragma-pack（n-指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1-2-4-8等2的幂值）中最小的一个的整数倍"><span class="nav-number">1.2.1.</span> <span class="nav-text">1. 内置类型对象(如char、int<现代PC编译器普遍为4字节>等)的对齐起始地址为其本身大小和编译器默认大小（或用#pragma pack（n)指定的n，一般编译器默认为8字节，可用菜单等命令修改，n一般为1,2,4,8等2的幂值）中最小的一个的整数倍.</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-整个结构体或者类的大小为它们中的内置类型大小最大的那一个和编译器默认大小（或用-pragma-pack-n-指定的n中两者较小的那个的整数倍-而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。"><span class="nav-number">1.2.2.</span> <span class="nav-text">2. 整个结构体或者类的大小为它们中的内置类型大小最大的那一个和编译器默认大小（或用#pragma pack (n)指定的n中两者较小的那个的整数倍,而当结构体或者类为定义对象的自定义类型定义时，其对齐方式参照其本身内置的最大的那个的然后再和编译器默认或声明比较中小的那个，意思说由它们中最小的那个代表它们来进行上述操作。</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Win栗子如下："><span class="nav-number">1.3.</span> <span class="nav-text">3. Win栗子如下：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-这是以前我用Win的时候VC-6-0编译器的效果图"><span class="nav-number">1.3.1.</span> <span class="nav-text">1. 这是以前我用Win的时候VC++ 6.0编译器的效果图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的"><span class="nav-number">1.3.2.</span> <span class="nav-text">2. 此处说明int类型的b在排位置的时候放到了偏移处为4的倍数，而非数据填充a剩下的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-下面这一处说明大小是按照int类型-最大呀-的整数倍来取"><span class="nav-number">1.3.3.</span> <span class="nav-text">3. 下面这一处说明大小是按照int类型(最大呀)的整数倍来取</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-说明当类型为数组的时候，只按照它的类型来对齐而非整个大小"><span class="nav-number">1.3.4.</span> <span class="nav-text">4. 说明当类型为数组的时候，只按照它的类型来对齐而非整个大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-说明第二个元素char类型的可以在任何偏移处安放-因为它是一个字节啊"><span class="nav-number">1.3.5.</span> <span class="nav-text">5. 说明第二个元素char类型的可以在任何偏移处安放(因为它是一个字节啊)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-说明-pragma-pack-n-n非2的幂的值时候无效"><span class="nav-number">1.3.6.</span> <span class="nav-text">6. 说明#pragma pack (n) n非2的幂的值时候无效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数"><span class="nav-number">1.3.7.</span> <span class="nav-text">7. 说明结构体作为一个类型在插入时候是以它自己有的最大字节元素来参考放的偏移．然后总的大小是8的倍数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-说明pragma-pack-3-没作用"><span class="nav-number">1.3.8.</span> <span class="nav-text">8. 说明pragma pack (3)没作用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Linux栗子如下-据说gcc默认是4-bytes的对齐大小-："><span class="nav-number">1.4.</span> <span class="nav-text">4. Linux栗子如下(据说gcc默认是4 bytes的对齐大小)：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-这是我用ubuntu-16-04-amd64-ssh连接ubuntu-16-04-i386之后gcc版本号"><span class="nav-number">1.4.1.</span> <span class="nav-text">1. 这是我用ubuntu 16.04 amd64 ssh连接ubuntu 16.04 i386之后gcc版本号:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节"><span class="nav-number">1.4.2.</span> <span class="nav-text">2. 这个应该默认是4字节的对齐，大小和元素中最大的int比还是4字节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-在gcc中加入功能和pragma-pack差不多的attribute选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…"><span class="nav-number">1.4.3.</span> <span class="nav-text">3. 在gcc中加入功能和pragma pack差不多的attribute选项即可要求编译器改变默认对齐大小，当值为1时，几乎没有空间浪费，但是用起来的时候却去坑CPU了…</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-在这里只是a之后的那一个字节是填充的-short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，attribute干得好事"><span class="nav-number">1.4.4.</span> <span class="nav-text">4. 在这里只是a之后的那一个字节是填充的,short只要是偶数偏移就可以插入咯，int在这里其实也是偶数，只是恰好放在4的倍数偏移处而已，attribute干得好事~</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-证明了有pack为1的地方必定不留一点空隙"><span class="nav-number">1.4.5.</span> <span class="nav-text">5. 证明了有pack为1的地方必定不留一点空隙~~~</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢-应该是它自己作为结构体的时候元素中最大的-这个栗子为double-要是有char-类型数组超过8，不用管，认为是char-和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．"><span class="nav-number">1.4.6.</span> <span class="nav-text">6. 第一个foo结构体虽然double为8字节，但是由于默认为4字节的对齐，所以根据对齐原则取两者中较小的对结构体大小倍数，因此为12字节．第二个结构体bar插入了第一个结构体，因此结构体d放在哪儿呢?应该是它自己作为结构体的时候元素中最大的(这个栗子为double,要是有char 类型数组超过8，不用管，认为是char)和默认的4相比，还是取较小的为偏移处防止，所以short之后空两个就可以插入了．大小也是一样，直接占12字节就是了．后面的参照规则即可得出．</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．"><span class="nav-number">1.4.7.</span> <span class="nav-text">7. 由于第一个结构体声明为1字节的对齐粒度，因此全部都占着吧，但是bar结构体剩余的元素都必须和默认的4进行比较，来放置和占大小．</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-C-中的高级之处"><span class="nav-number">1.5.</span> <span class="nav-text">5. C++中的高级之处</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-C-中的结构体和类的区别？"><span class="nav-number">1.5.1.</span> <span class="nav-text">1.C++中的结构体和类的区别？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-C-中class的虚函数"><span class="nav-number">1.5.2.</span> <span class="nav-text">2. C++中class的虚函数</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">rutk1t0r</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blog-rutk1t0r"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = false;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = decodeURIComponent(data.url);
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title >= 0 || index_content >= 0 ){
                                isMatch = true;
								if (i == 0) {
                                    first_occur = index_content;
                                }
                            } 
							
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });

                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
