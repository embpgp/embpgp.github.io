---
title: Linux内核0-11完全注释 第四章
date: 2016-11-19 21:36:22
categories:
- study
tags:
- C/C++
- Linux kernel
- Asm
- LDD
---

> 介绍Intel 80X86保护模式及其编程

-----------


# 80X86基础知识
## eflags标志寄存器
- 几个系统标志的作用，其中需要说明的IF标志位也是可以控制的，通过汇编指令`sti`和`cli`。需要特权才能执行，否则产生异常。Intel芯片的设计者增加这几个标志位的目的是为了配合操作系统更好地管理系统资源以及安全性的提升，诚然操作系统设计者可以不用理会部分标志，但是有这些硬件机制使得程序流程执行起来更加快速。
![Linux_0.11_chapter4_eflag_sys.png](/images/Linux_0.11_chapter4_eflag_sys.png)  

## 内存管理寄存器
> 由于80386及以后的CPU的主要工作状态均采用保护模式(相对于8086时代的实模式)，其实所谓的保护最主要的还是保护内存，DOS时代的病毒太过于泛滥的主要原因之一是当时8086的内存保护几乎为0。因此真正懂得程序布局和设计的早期hacker可以随意"摆弄"计算机。而保护模式便要大大提高门槛了，把恶意指令限制在CPU内部解决而不直接通过系统总线送往内存控制器。  


### GDTR
- 全局描述符表寄存器，CPU内部，48位，保存GDT的32位线性基地址和16位表长度(字节)
- 使用汇编指令LGDT和SGDT来加载和保存GDTR的内容
- 刚刚上电初始化base为0,len为0xFFFF
- boot阶段进入保护模式过程中必须被赋值,因为一旦进入保护模式便要一直用它

### IDTR
- 中断描述符寄存器,CPU内部，48位，保存IDT的32位线性地址和16位表长度(字节为单位)
- LIDT和SIDT
- 上电同上
- 也是必须被设置，但是初始化过程中可以关闭中断使得如同空设。而后必须填充好。

### LDTR
- 不仅包含和GDTR的48位,还有段属性以及选择子
- 可用于任务切换的局部空间寻址

### TR
- 同上，但描述符部分属性和内容更多

## 控制寄存器
### CRO
- 主要含有控制处理器模式和状态的系统控指标志
- 协处理器的相关控制(浮点计算)
- 保护模式开启和关闭以及分页模式的启毕 

 
### CR1 Intel保留  
  

### CR2 
- 异常的线性地址保存CR2，便于实现虚拟内存


### CR3
- PDBR，高20位为页目录基地址，低12位暂时保留。
- 任务切换时被更新，分页机制的第一基点



# 保护模式内存管理
## 地址变换
![Linux_0.11_chapter4_address_convert.png](/images/Linux_0.11_chapter4_address_convert.png)

## 段的定义
> Intel芯片中的分段机制必须开启，但是软件开发人员可以采用平坦模式，即配置分段机制的各个选择子描述符基址为0，长度为4G，好处是便于后期编程。

### 段描述符
- GDT 
 - 8字节,含段基址，段限长及段属性，可表示(类似继承)成各种段，包括代码段，数据段，tss段等等
 - 由GDTR指向，一般确定后不会更改地址，可以增加项目
　- 第一项约定必须为空
- LDT
 - 属性差不多同上，但只能包含成任务的代码段和数据段等，不包含特殊系统段。
 - 第一项可以用

### 段选择符
![Linux_0.11_chapter4_sector.png](/images/Linux_0.11_chapter4_sector.png)
![Linux_0.11_chapter4_sector_CDEFGS.png](/images/Linux_0.11_chapter4_sector_CDEFGS.png)
# 各种保护措施
# 中断和异常处理
# 任务管理
# 保护模式编程的初始化
# 一个简单的多任务内核例子
