---
title: fmt exploit
date: 2017-01-06 14:22:39
categories:
- study
- misc

tags:
- exploit
- C/C++
- shellcode
---

参考:
[http://www.freebuf.com/articles/system/74224.html](http://www.freebuf.com/articles/system/74224.html)
[http://nullablesecurity.blogspot.co.uk/](http://nullablesecurity.blogspot.co.uk/)
[https://github.com/shiyanlou/seedlab/blob/master/formatstring.md](https://github.com/shiyanlou/seedlab/blob/master/formatstring.md)
[http://staff.ustc.edu.cn/~billzeng/seclab/selab02.pdf](http://staff.ustc.edu.cn/~billzeng/seclab/selab02.pdf)
[The Shellcoder's Handbook](https://www.amazon.com/Shellcoders-Handbook-Discovering-Exploiting-Security/dp/047008023X/ref=sr_1_1?ie=UTF8&qid=1483684023&sr=8-1&keywords=shellcoders+handbook)
[从零开始学习软件漏洞挖掘系列教程](http://bbs.pediy.com/)
[0day安全 软件漏洞分析技术](http://bbs.pediy.com/)
[https://zhuanlan.zhihu.com/p/24489276](https://zhuanlan.zhihu.com/p/24489276)
[逆向工程学习平台](http://www.cis.syr.edu/~wedu/seed/)


> 一直会深入底层学习


-----------------------------------

# 再说说fmt
在之前一篇[《一起来撸printf吧》](http://www.rutk1t0r.org/2016/09/25/%E4%B8%80%E8%B5%B7%E6%9D%A5%E6%92%B8printf%E5%90%A7/)中分析了内核中printf(printk)的大体实现，即可以进行一些简单地调试输出，因此实现了基本的参数格式化包括%n。但是应用开发者一般都是使用的glibc提供的C运行时库。而其[实现](ftp://ftp.gnu.org/gnu/glibc/)更为复杂，有兴趣的可以参考。微软貌似不太一样，没有实现诸如`%$n`中的`$`控制，当然也可以不需要`$`直接通过之前输入的字符控制。根据前文分析得知类似printf类的函数还有很多，最后大都调用vfprintf函数进一步解析参数，一般不检查参数的合法性而直接进行格式化，写入或读出。因此编译的时候gcc有时候会提示不安全的警告。

# 来个小实验

## 平台
```bash
OS 版本:4.4.0-58-generic #79-Ubuntu SMP Tue Dec 20 12:12:31 UTC 2016 i686 i686 i686 GNU/Linux
gcc: gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.4)
libc: lrwxrwxrwx 1 root root 12 11月 17 06:51 /lib/i386-linux-gnu/libc.so.6 -> libc-2.23.so
```
## 测试例程
```bash
pgp@Rutk1t0r:ch04$ ls
ascii.c  dowu.c  exit.c  fmt  fmt.c  gen_upload_string.c  Makefile  test.txt
pgp@Rutk1t0r:ch04$ cat fmt.c 
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
/*I have changed the code,so let it work*/

/*In order to implement arbitrary address write I need some local vars and strcpy them.*/
/*But I don't need overflow the stack*/

int main( int argc, char *argv[] )
{
	char evil[128];
	strcpy(evil, argv[1]);
	printf( argv[1]);
	return 0;
}
pgp@Rutk1t0r:ch04$ cat Makefile 

fmt: fmt.c
	gcc -fno-stack-protector -z execstack -o fmt fmt.c 
pgp@Rutk1t0r:ch04$

```
